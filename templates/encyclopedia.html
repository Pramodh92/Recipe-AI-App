{% extends "base.html" %}

{% block title %}Culinary Encyclopedia - AI Recipe Hub{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-lg-8 mx-auto text-center">
            <h1 class="display-4 fw-bold mb-3">
                <i class="fas fa-book-open text-primary me-3"></i>
                Culinary Encyclopedia
            </h1>
            <p class="lead text-muted">
                Learn cooking techniques, food science, and culinary terms with AI-powered explanations
            </p>
        </div>
    </div>

    <!-- Search Section -->
    <div class="row mb-5">
        <div class="col-lg-8 mx-auto">
            <div class="search-card card shadow-lg border-0">
                <div class="card-body p-4">
                    <form id="encyclopediaSearchForm">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-primary text-white">
                                <i class="fas fa-search"></i>
                            </span>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="encyclopediaQuery" 
                                placeholder="Ask about cooking techniques, ingredients, or food science..."
                                autocomplete="off"
                            >
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-magic me-2"></i>
                                Ask AI
                            </button>
                        </div>
                    </form>
                    
                    <!-- Search Suggestions -->
                    <div class="search-suggestions mt-3">
                        <small class="text-muted">Try asking about:</small>
                        <div class="suggestion-tags mt-2">
                            <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2 suggestion-tag">
                                What is the Maillard reaction?
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2 suggestion-tag">
                                How to properly sauté vegetables?
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2 suggestion-tag">
                                Difference between braising and stewing
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2 suggestion-tag">
                                Why does baking soda make things fluffy?
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2 suggestion-tag">
                                What is umami flavor?
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2 suggestion-tag">
                                How to properly season cast iron?
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="encyclopediaResults" class="row" style="display: none;">
        <div class="col-12">
            <div class="results-card card shadow border-0">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        AI Explanation
                    </h4>
                </div>
                <div class="card-body" id="encyclopediaExplanation">
                    <!-- AI explanation will be inserted here -->
                </div>
                <div class="card-footer bg-light">
                    <div class="result-actions d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-primary btn-sm" id="saveExplanation">
                            <i class="fas fa-bookmark me-1"></i>Save
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="shareExplanation">
                            <i class="fas fa-share me-1"></i>Share
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="translateExplanation">
                            <i class="fas fa-language me-1"></i>Translate
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="printExplanation">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Categories -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="text-center mb-4">Explore by Category</h3>
            <div class="category-grid row g-4">
                <div class="col-md-6 col-lg-3">
                    <div class="category-card card h-100 border-0 shadow-sm">
                        <div class="card-body text-center">
                            <div class="category-icon bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                <i class="fas fa-fire fa-2x"></i>
                            </div>
                            <h5 class="card-title">Cooking Techniques</h5>
                            <p class="card-text text-muted">Learn about different cooking methods and when to use them</p>
                            <div class="category-examples">
                                <small class="text-muted">
                                    Examples: Sautéing, Braising, Grilling, Roasting
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-3">
                    <div class="category-card card h-100 border-0 shadow-sm">
                        <div class="card-body text-center">
                            <div class="category-icon bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                <i class="fas fa-flask fa-2x"></i>
                            </div>
                            <h5 class="card-title">Food Science</h5>
                            <p class="card-text text-muted">Understand the science behind cooking and baking</p>
                            <div class="category-examples">
                                <small class="text-muted">
                                    Examples: Maillard Reaction, Gluten Formation, Fermentation
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-3">
                    <div class="category-card card h-100 border-0 shadow-sm">
                        <div class="card-body text-center">
                            <div class="category-icon bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                <i class="fas fa-seedling fa-2x"></i>
                            </div>
                            <h5 class="card-title">Ingredients</h5>
                            <p class="card-text text-muted">Learn about ingredients and their properties</p>
                            <div class="category-examples">
                                <small class="text-muted">
                                    Examples: Spices, Herbs, Oils, Vinegars
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-3">
                    <div class="category-card card h-100 border-0 shadow-sm">
                        <div class="card-body text-center">
                            <div class="category-icon bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                <i class="fas fa-utensils fa-2x"></i>
                            </div>
                            <h5 class="card-title">Tools & Equipment</h5>
                            <p class="card-text text-muted">Master your kitchen tools and equipment</p>
                            <div class="category-examples">
                                <small class="text-muted">
                                    Examples: Knives, Pans, Thermometers, Mixers
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popular Questions -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="text-center mb-4">Popular Questions</h3>
            <div class="popular-questions accordion" id="popularQuestionsAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#question1">
                            What's the difference between sautéing and stir-frying?
                        </button>
                    </h2>
                    <div id="question1" class="accordion-collapse collapse" data-bs-parent="#popularQuestionsAccordion">
                        <div class="accordion-body">
                            <button class="btn btn-primary btn-sm" onclick="askPredefinedQuestion('What is the difference between sautéing and stir-frying?')">
                                <i class="fas fa-magic me-1"></i>Get AI Explanation
                            </button>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#question2">
                            How does salt enhance flavor in cooking?
                        </button>
                    </h2>
                    <div id="question2" class="accordion-collapse collapse" data-bs-parent="#popularQuestionsAccordion">
                        <div class="accordion-body">
                            <button class="btn btn-primary btn-sm" onclick="askPredefinedQuestion('How does salt enhance flavor in cooking?')">
                                <i class="fas fa-magic me-1"></i>Get AI Explanation
                            </button>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#question3">
                            Why do onions make you cry when cutting them?
                        </button>
                    </h2>
                    <div id="question3" class="accordion-collapse collapse" data-bs-parent="#popularQuestionsAccordion">
                        <div class="accordion-body">
                            <button class="btn btn-primary btn-sm" onclick="askPredefinedQuestion('Why do onions make you cry when cutting them?')">
                                <i class="fas fa-magic me-1"></i>Get AI Explanation
                            </button>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#question4">
                            What happens when you cream butter and sugar?
                        </button>
                    </h2>
                    <div id="question4" class="accordion-collapse collapse" data-bs-parent="#popularQuestionsAccordion">
                        <div class="accordion-body">
                            <button class="btn btn-primary btn-sm" onclick="askPredefinedQuestion('What happens when you cream butter and sugar in baking?')">
                                <i class="fas fa-magic me-1"></i>Get AI Explanation
                            </button>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#question5">
                            How to properly rest meat after cooking?
                        </button>
                    </h2>
                    <div id="question5" class="accordion-collapse collapse" data-bs-parent="#popularQuestionsAccordion">
                        <div class="accordion-body">
                            <button class="btn btn-primary btn-sm" onclick="askPredefinedQuestion('How to properly rest meat after cooking and why?')">
                                <i class="fas fa-magic me-1"></i>Get AI Explanation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Translation Modal -->
<div class="modal fade" id="translationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-language me-2"></i>
                    Translate Explanation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="targetLanguage" class="form-label">Select Language:</label>
                    <select class="form-select" id="targetLanguage">
                        <option value="es">Español</option>
                        <option value="fr">Français</option>
                        <option value="de">Deutsch</option>
                        <option value="it">Italiano</option>
                        <option value="ja">日本語</option>
                        <option value="zh">中文</option>
                        <option value="ko">한국어</option>
                        <option value="pt">Português</option>
                        <option value="ru">Русский</option>
                        <option value="ar">العربية</option>
                    </select>
                </div>
                <div id="translatedContent" class="mt-3" style="display: none;">
                    <h6>Translated Content:</h6>
                    <div class="translation-result bg-light p-3 rounded"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="performTranslation">
                    <i class="fas fa-language me-1"></i>Translate
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class EncyclopediaManager {
    constructor() {
        this.currentExplanation = '';
        this.currentQuery = '';
        this.init();
    }

    init() {
        this.setupEventListeners();
    }

    setupEventListeners() {
        // Search form
        const searchForm = document.getElementById('encyclopediaSearchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', this.handleSearch.bind(this));
        }

        // Suggestion tags
        const suggestionTags = document.querySelectorAll('.suggestion-tag');
        suggestionTags.forEach(tag => {
            tag.addEventListener('click', () => {
                document.getElementById('encyclopediaQuery').value = tag.textContent;
                this.handleSearch();
            });
        });

        // Result actions
        this.setupResultActions();
    }

    setupResultActions() {
        const saveBtn = document.getElementById('saveExplanation');
        const shareBtn = document.getElementById('shareExplanation');
        const translateBtn = document.getElementById('translateExplanation');
        const printBtn = document.getElementById('printExplanation');
        const performTranslationBtn = document.getElementById('performTranslation');

        if (saveBtn) {
            saveBtn.addEventListener('click', this.saveExplanation.bind(this));
        }

        if (shareBtn) {
            shareBtn.addEventListener('click', this.shareExplanation.bind(this));
        }

        if (translateBtn) {
            translateBtn.addEventListener('click', this.showTranslationModal.bind(this));
        }

        if (printBtn) {
            printBtn.addEventListener('click', this.printExplanation.bind(this));
        }

        if (performTranslationBtn) {
            performTranslationBtn.addEventListener('click', this.translateContent.bind(this));
        }
    }

    async handleSearch(e) {
        if (e) e.preventDefault();

        const query = document.getElementById('encyclopediaQuery').value.trim();
        if (!query) {
            RecipeApp.showAlert('Please enter a question or topic', 'warning');
            return;
        }

        this.currentQuery = query;

        try {
            RecipeApp.showLoading('Consulting our AI culinary expert...', 'Preparing detailed explanation');

            const response = await fetch('/ai/culinary-encyclopedia', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(RecipeApp.authToken() ? { 'Authorization': `Bearer ${RecipeApp.authToken()}` } : {})
                },
                body: JSON.stringify({ query: query })
            });

            const data = await response.json();
            RecipeApp.hideLoading();

            if (data.success) {
                this.displayExplanation(data.explanation);
            } else {
                RecipeApp.showAlert('Failed to get explanation. Please try again.', 'error');
            }
        } catch (error) {
            RecipeApp.hideLoading();
            console.error('Encyclopedia search error:', error);
            RecipeApp.showAlert('Network error. Please try again.', 'error');
        }
    }

    displayExplanation(explanation) {
        this.currentExplanation = explanation;
        
        const resultsSection = document.getElementById('encyclopediaResults');
        const explanationDiv = document.getElementById('encyclopediaExplanation');

        if (resultsSection && explanationDiv) {
            // Format the explanation text
            const formattedExplanation = this.formatExplanation(explanation);
            explanationDiv.innerHTML = formattedExplanation;
            
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
    }

    formatExplanation(text) {
        // Convert line breaks to paragraphs and add formatting
        const paragraphs = text.split('\n\n');
        let formattedText = '';

        paragraphs.forEach(paragraph => {
            if (paragraph.trim()) {
                // Check if it's a heading (contains numbers or starts with capital)
                if (paragraph.match(/^\d+\./) || paragraph.match(/^[A-Z][^.]+:$/)) {
                    formattedText += `<h6 class="text-primary mt-3 mb-2">${paragraph.trim()}</h6>`;
                } else {
                    formattedText += `<p class="mb-3">${paragraph.trim()}</p>`;
                }
            }
        });

        // Add some visual enhancements
        formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>');

        return formattedText;
    }

    async saveExplanation() {
        if (!RecipeApp.authToken()) {
            RecipeApp.showAlert('Please login to save explanations', 'warning');
            return;
        }

        // Future implementation: Save to user's favorites
        RecipeApp.showAlert('Save functionality coming soon!', 'info');
    }

    shareExplanation() {
        if (navigator.share && this.currentExplanation) {
            navigator.share({
                title: `Culinary Question: ${this.currentQuery}`,
                text: this.currentExplanation.substring(0, 200) + '...',
                url: window.location.href
            });
        } else {
            // Fallback to clipboard
            const shareText = `${this.currentQuery}\n\n${this.currentExplanation}`;
            navigator.clipboard.writeText(shareText).then(() => {
                RecipeApp.showAlert('Explanation copied to clipboard!', 'success');
            }).catch(() => {
                RecipeApp.showAlert('Unable to copy to clipboard', 'error');
            });
        }
    }

    showTranslationModal() {
        if (!this.currentExplanation) {
            RecipeApp.showAlert('No explanation to translate', 'warning');
            return;
        }

        const modal = new bootstrap.Modal(document.getElementById('translationModal'));
        modal.show();
    }

    async translateContent() {
        const targetLanguage = document.getElementById('targetLanguage').value;
        const translatedContent = document.getElementById('translatedContent');
        const translationResult = translatedContent.querySelector('.translation-result');

        try {
            RecipeApp.showLoading('Translating content...', 'Please wait while we translate the explanation');

            const response = await fetch('/ai/translate-content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: this.currentExplanation,
                    target_language: targetLanguage
                })
            });

            const data = await response.json();
            RecipeApp.hideLoading();

            if (data.success) {
                translationResult.innerHTML = this.formatExplanation(data.translated_text);
                translatedContent.style.display = 'block';
            } else {
                RecipeApp.showAlert('Translation failed. Please try again.', 'error');
            }
        } catch (error) {
            RecipeApp.hideLoading();
            console.error('Translation error:', error);
            RecipeApp.showAlert('Translation failed. Please try again.', 'error');
        }
    }

    printExplanation() {
        if (!this.currentExplanation) {
            RecipeApp.showAlert('No explanation to print', 'warning');
            return;
        }

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Culinary Encyclopedia - ${this.currentQuery}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                        h1 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                        h6 { color: #007bff; margin-top: 20px; }
                        p { margin-bottom: 15px; }
                        @media print { body { font-size: 12pt; } }
                    </style>
                </head>
                <body>
                    <h1>${this.currentQuery}</h1>
                    <div class="explanation">
                        ${this.formatExplanation(this.currentExplanation)}
                    </div>
                    <hr>
                    <p><small>Generated by AI Recipe Hub - ${new Date().toLocaleDateString()}</small></p>
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }
}

// Global function for predefined questions
window.askPredefinedQuestion = function(question) {
    document.getElementById('encyclopediaQuery').value = question;
    encyclopediaManager.handleSearch();
}

// Initialize encyclopedia manager
let encyclopediaManager;
document.addEventListener('DOMContentLoaded', function() {
    encyclopediaManager = new EncyclopediaManager();
});
</script>
{% endblock %}
