{% extends "base.html" %}

{% block title %}My Profile - AI Recipe Hub{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Profile Sidebar -->
        <div class="col-lg-4 mb-4">
            <div class="profile-card card shadow border-0">
                <div class="card-header bg-primary text-white text-center">
                    <div class="profile-avatar mb-3">
                        <div class="avatar-circle bg-white text-primary d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px; border-radius: 50%; font-size: 2rem; font-weight: bold;">
                            {{ user.name[0].upper() if user else 'U' }}
                        </div>
                    </div>
                    <h4 class="mb-1">{{ user.name if user else 'User Name' }}</h4>
                    <p class="mb-0">{{ user.email if user else 'user@example.com' }}</p>
                </div>
                <div class="card-body">
                    <div class="profile-stats">
                        <div class="stat-item d-flex justify-content-between align-items-center mb-3">
                            <div class="stat-info">
                                <i class="fas fa-utensils text-primary me-2"></i>
                                <span>Recipes Generated</span>
                            </div>
                            <span class="badge bg-primary" id="recipesGenerated">0</span>
                        </div>
                        
                        <div class="stat-item d-flex justify-content-between align-items-center mb-3">
                            <div class="stat-info">
                                <i class="fas fa-heart text-danger me-2"></i>
                                <span>Saved Recipes</span>
                            </div>
                            <span class="badge bg-danger" id="savedRecipes">0</span>
                        </div>
                        
                        <div class="stat-item d-flex justify-content-between align-items-center mb-3">
                            <div class="stat-info">
                                <i class="fas fa-calendar-alt text-success me-2"></i>
                                <span>Meal Plans</span>
                            </div>
                            <span class="badge bg-success" id="mealPlans">0</span>
                        </div>
                        
                        <div class="stat-item d-flex justify-content-between align-items-center">
                            <div class="stat-info">
                                <i class="fas fa-shopping-cart text-info me-2"></i>
                                <span>Shopping Lists</span>
                            </div>
                            <span class="badge bg-info" id="shoppingLists">0</span>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="profile-achievements">
                        <h6 class="mb-3">
                            <i class="fas fa-trophy text-warning me-2"></i>
                            Achievements
                        </h6>
                        <div id="achievementsList">
                            <div class="achievement-item d-flex align-items-center mb-2">
                                <i class="fas fa-medal text-warning me-2"></i>
                                <small>First Recipe Generated</small>
                            </div>
                            <div class="achievement-item d-flex align-items-center mb-2">
                                <i class="fas fa-star text-warning me-2"></i>
                                <small>Recipe Explorer</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="col-lg-8">
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                        <i class="fas fa-cog me-2"></i>Settings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button" role="tab">
                        <i class="fas fa-sliders-h me-2"></i>Preferences
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                        <i class="fas fa-history me-2"></i>Activity
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="privacy-tab" data-bs-toggle="tab" data-bs-target="#privacy" type="button" role="tab">
                        <i class="fas fa-shield-alt me-2"></i>Privacy
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="profileTabContent">
                <!-- Settings Tab -->
                <div class="tab-pane fade show active" id="settings" role="tabpanel">
                    <div class="card shadow border-0">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-user-edit me-2"></i>
                                Account Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="profileSettingsForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="firstName" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="firstName" value="{{ user.name.split()[0] if user and user.name else '' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="lastName" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="lastName" value="{{ user.name.split()[1] if user and user.name and user.name.split()|length > 1 else '' }}">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" value="{{ user.email if user else '' }}" readonly>
                                    <div class="form-text">Email cannot be changed. Contact support if needed.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone Number (Optional)</label>
                                    <input type="tel" class="form-control" id="phone" placeholder="+1 (555) 123-4567">
                                </div>
                                
                                <div class="mb-4">
                                    <label for="bio" class="form-label">Bio</label>
                                    <textarea class="form-control" id="bio" rows="3" placeholder="Tell us a bit about yourself and your cooking interests..."></textarea>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>Save Changes
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                        <i class="fas fa-undo me-1"></i>Reset
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Password Change -->
                    <div class="card shadow border-0 mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-lock me-2"></i>
                                Change Password
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="passwordChangeForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">Current Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="currentPassword" required>
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('currentPassword')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">New Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="newPassword" required>
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('newPassword')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="password-strength mt-2">
                                        <div class="progress" style="height: 4px;">
                                            <div class="progress-bar" id="passwordStrengthBar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="passwordStrengthText">Enter new password</small>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="confirmNewPassword" required>
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('confirmNewPassword')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-key me-1"></i>Update Password
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Preferences Tab -->
                <div class="tab-pane fade" id="preferences" role="tabpanel">
                    <div class="card shadow border-0">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>
                                AI & Recipe Preferences
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="preferencesForm">
                                <div class="mb-4">
                                    <label for="preferredLanguage" class="form-label">Preferred Language</label>
                                    <select class="form-select" id="preferredLanguage">
                                        <option value="en" {{ 'selected' if user and user.preferred_language == 'en' else '' }}>English</option>
                                        <option value="es" {{ 'selected' if user and user.preferred_language == 'es' else '' }}>Español</option>
                                        <option value="fr" {{ 'selected' if user and user.preferred_language == 'fr' else '' }}>Français</option>
                                        <option value="de" {{ 'selected' if user and user.preferred_language == 'de' else '' }}>Deutsch</option>
                                        <option value="it" {{ 'selected' if user and user.preferred_language == 'it' else '' }}>Italiano</option>
                                        <option value="ja" {{ 'selected' if user and user.preferred_language == 'ja' else '' }}>日本語</option>
                                    </select>
                                    <div class="form-text">AI will generate recipes and explanations in your preferred language</div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label">Dietary Restrictions</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="vegetarian" name="dietaryRestrictions[]" value="vegetarian">
                                                <label class="form-check-label" for="vegetarian">Vegetarian</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="vegan" name="dietaryRestrictions[]" value="vegan">
                                                <label class="form-check-label" for="vegan">Vegan</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="glutenFree" name="dietaryRestrictions[]" value="gluten-free">
                                                <label class="form-check-label" for="glutenFree">Gluten-Free</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="keto" name="dietaryRestrictions[]" value="keto">
                                                <label class="form-check-label" for="keto">Keto</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="paleo" name="dietaryRestrictions[]" value="paleo">
                                                <label class="form-check-label" for="paleo">Paleo</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="dairyFree" name="dietaryRestrictions[]" value="dairy-free">
                                                <label class="form-check-label" for="dairyFree">Dairy-Free</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label">Favorite Cuisines</label>
                                    <div class="cuisine-tags">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="italian" value="italian">
                                            <label class="form-check-label" for="italian">Italian</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="mexican" value="mexican">
                                            <label class="form-check-label" for="mexican">Mexican</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="chinese" value="chinese">
                                            <label class="form-check-label" for="chinese">Chinese</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="indian" value="indian">
                                            <label class="form-check-label" for="indian">Indian</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="japanese" value="japanese">
                                            <label class="form-check-label" for="japanese">Japanese</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="mediterranean" value="mediterranean">
                                            <label class="form-check-label" for="mediterranean">Mediterranean</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="defaultServings" class="form-label">Default Recipe Servings</label>
                                    <select class="form-select" id="defaultServings">
                                        <option value="2">2 people</option>
                                        <option value="4" selected>4 people</option>
                                        <option value="6">6 people</option>
                                        <option value="8">8 people</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label for="skillLevel" class="form-label">Cooking Skill Level</label>
                                    <select class="form-select" id="skillLevel">
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate" selected>Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                        <option value="expert">Expert</option>
                                    </select>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Save Preferences
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="card shadow border-0 mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bell me-2"></i>
                                Notification Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="notification-setting d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>Recipe Recommendations</strong>
                                    <div class="text-muted small">Get personalized recipe suggestions</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="recipeNotifications" checked>
                                </div>
                            </div>
                            
                            <div class="notification-setting d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>Meal Planning Reminders</strong>
                                    <div class="text-muted small">Reminders to plan your weekly meals</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="mealPlanNotifications" checked>
                                </div>
                            </div>
                            
                            <div class="notification-setting d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>Shopping List Updates</strong>
                                    <div class="text-muted small">Notifications about shopping list features</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="shoppingNotifications">
                                </div>
                            </div>
                            
                            <div class="notification-setting d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Cooking Tips</strong>
                                    <div class="text-muted small">Weekly cooking tips and techniques</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="tipsNotifications" checked>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div class="tab-pane fade" id="activity" role="tabpanel">
                    <div class="card shadow border-0">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>
                                Recent Activity
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="activityTimeline">
                                <!-- Activity items will be loaded here -->
                                <div class="activity-item d-flex mb-3">
                                    <div class="activity-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                    <div class="activity-content">
                                        <h6 class="mb-1">Generated "Chicken Stir Fry" recipe</h6>
                                        <small class="text-muted">2 hours ago</small>
                                    </div>
                                </div>
                                
                                <div class="activity-item d-flex mb-3">
                                    <div class="activity-icon bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <div class="activity-content">
                                        <h6 class="mb-1">Saved "Pasta Carbonara" to favorites</h6>
                                        <small class="text-muted">1 day ago</small>
                                    </div>
                                </div>
                                
                                <div class="activity-item d-flex mb-3">
                                    <div class="activity-icon bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-calendar"></i>
                                    </div>
                                    <div class="activity-content">
                                        <h6 class="mb-1">Created meal plan for this week</h6>
                                        <small class="text-muted">2 days ago</small>
                                    </div>
                                </div>
                                
                                <div class="activity-item d-flex">
                                    <div class="activity-icon bg-warning text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                    <div class="activity-content">
                                        <h6 class="mb-1">Generated shopping list with 23 items</h6>
                                        <small class="text-muted">3 days ago</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button class="btn btn-outline-primary" id="loadMoreActivity">
                                    <i class="fas fa-plus me-1"></i>Load More Activity
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Privacy Tab -->
                <div class="tab-pane fade" id="privacy" role="tabpanel">
                    <div class="card shadow border-0">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>
                                Privacy & Security
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="privacy-section mb-4">
                                <h6>Data Usage</h6>
                                <div class="privacy-setting d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <strong>Allow recipe sharing</strong>
                                        <div class="text-muted small">Let others see recipes you create (anonymously)</div>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="allowSharing" checked>
                                    </div>
                                </div>
                                
                                <div class="privacy-setting d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <strong>Usage analytics</strong>
                                        <div class="text-muted small">Help improve our AI by sharing anonymous usage data</div>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="analytics" checked>
                                    </div>
                                </div>
                            </div>

                            <div class="privacy-section mb-4">
                                <h6>Account Security</h6>
                                <div class="security-info">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Two-Factor Authentication</span>
                                        <button class="btn btn-sm btn-outline-primary" id="enable2FA">
                                            Enable
                                        </button>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Login Sessions</span>
                                        <button class="btn btn-sm btn-outline-secondary" id="manageSessions">
                                            Manage
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="privacy-section">
                                <h6 class="text-danger">Danger Zone</h6>
                                <div class="border border-danger rounded p-3">
                                    <div class="mb-3">
                                        <strong>Export Account Data</strong>
                                        <div class="text-muted small mb-2">Download all your account data</div>
                                        <button class="btn btn-outline-info btn-sm" id="exportData">
                                            <i class="fas fa-download me-1"></i>Export Data
                                        </button>
                                    </div>
                                    
                                    <div>
                                        <strong>Delete Account</strong>
                                        <div class="text-muted small mb-2">Permanently delete your account and all data</div>
                                        <button class="btn btn-outline-danger btn-sm" id="deleteAccount">
                                            <i class="fas fa-trash me-1"></i>Delete Account
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Confirmation Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Delete Account
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Warning:</strong> This action cannot be undone. All your recipes, meal plans, and account data will be permanently deleted.
                </div>
                
                <p>To confirm deletion, please type <strong>DELETE</strong> in the box below:</p>
                <input type="text" class="form-control" id="deleteConfirmation" placeholder="Type DELETE to confirm">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete" disabled>
                    <i class="fas fa-trash me-1"></i>Delete My Account
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadUserStats();
    setupPasswordStrength();
    setupFormHandlers();
    setupDeleteConfirmation();
});

async function loadUserStats() {
    // Load user statistics
    try {
        // Mock data - in production, fetch from API
        document.getElementById('recipesGenerated').textContent = '12';
        document.getElementById('savedRecipes').textContent = '8';
        document.getElementById('mealPlans').textContent = '3';
        document.getElementById('shoppingLists').textContent = '5';
    } catch (error) {
        console.error('Error loading user stats:', error);
    }
}

function setupPasswordStrength() {
    const passwordInput = document.getElementById('newPassword');
    if (passwordInput) {
        passwordInput.addEventListener('input', checkPasswordStrength);
    }
}

function checkPasswordStrength() {
    const password = document.getElementById('newPassword').value;
    const strengthBar = document.getElementById('passwordStrengthBar');
    const strengthText = document.getElementById('passwordStrengthText');
    
    let strength = 0;
    let label = 'Very Weak';
    let color = 'bg-danger';
    
    if (password.length >= 8) strength += 25;
    if (/[A-Z]/.test(password)) strength += 25;
    if (/[a-z]/.test(password)) strength += 25;
    if (/[0-9]/.test(password)) strength += 25;
    
    if (strength === 0) {
        label = 'Enter password';
        color = 'bg-secondary';
    } else if (strength === 25) {
        label = 'Weak';
        color = 'bg-danger';
    } else if (strength === 50) {
        label = 'Fair';
        color = 'bg-warning';
    } else if (strength === 75) {
        label = 'Good';
        color = 'bg-info';
    } else if (strength === 100) {
        label = 'Strong';
        color = 'bg-success';
    }
    
    strengthBar.style.width = strength + '%';
    strengthBar.className = `progress-bar ${color}`;
    strengthText.textContent = label;
}

function setupFormHandlers() {
    // Profile settings form
    const profileForm = document.getElementById('profileSettingsForm');
    if (profileForm) {
        profileForm.addEventListener('submit', handleProfileUpdate);
    }

    // Password change form
    const passwordForm = document.getElementById('passwordChangeForm');
    if (passwordForm) {
        passwordForm.addEventListener('submit', handlePasswordChange);
    }

    // Preferences form
    const preferencesForm = document.getElementById('preferencesForm');
    if (preferencesForm) {
        preferencesForm.addEventListener('submit', handlePreferencesUpdate);
    }
}

async function handleProfileUpdate(e) {
    e.preventDefault();
    
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const bio = document.getElementById('bio').value.trim();
    
    try {
        RecipeApp.showLoading('Updating profile...');
        
        const response = await fetch('/auth/profile', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${RecipeApp.authToken()}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: `${firstName} ${lastName}`.trim(),
                phone: phone,
                bio: bio
            })
        });

        const data = await response.json();
        RecipeApp.hideLoading();

        if (data.success) {
            RecipeApp.showAlert('Profile updated successfully!', 'success');
        } else {
            RecipeApp.showAlert(data.message || 'Failed to update profile', 'error');
        }
    } catch (error) {
        RecipeApp.hideLoading();
        console.error('Profile update error:', error);
        RecipeApp.showAlert('Failed to update profile', 'error');
    }
}

async function handlePasswordChange(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmNewPassword').value;
    
    if (newPassword !== confirmPassword) {
        RecipeApp.showAlert('New passwords do not match', 'warning');
        return;
    }
    
    if (newPassword.length < 8) {
        RecipeApp.showAlert('New password must be at least 8 characters', 'warning');
        return;
    }
    
    try {
        RecipeApp.showLoading('Changing password...');
        
        // Mock API call - implement actual endpoint
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        RecipeApp.hideLoading();
        RecipeApp.showAlert('Password changed successfully!', 'success');
        
        // Clear form
        document.getElementById('passwordChangeForm').reset();
    } catch (error) {
        RecipeApp.hideLoading();
        console.error('Password change error:', error);
        RecipeApp.showAlert('Failed to change password', 'error');
    }
}

async function handlePreferencesUpdate(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const preferences = {
        preferred_language: document.getElementById('preferredLanguage').value,
        dietary_restrictions: Array.from(document.querySelectorAll('input[name="dietaryRestrictions[]"]:checked')).map(cb => cb.value),
        favorite_cuisines: Array.from(document.querySelectorAll('.cuisine-tags input:checked')).map(cb => cb.value),
        default_servings: document.getElementById('defaultServings').value,
        skill_level: document.getElementById('skillLevel').value
    };
    
    try {
        RecipeApp.showLoading('Saving preferences...');
        
        const response = await fetch('/auth/profile', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${RecipeApp.authToken()}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(preferences)
        });

        const data = await response.json();
        RecipeApp.hideLoading();

        if (data.success) {
            RecipeApp.showAlert('Preferences saved successfully!', 'success');
            
            // Update language display if changed
            if (preferences.preferred_language !== RecipeApp.currentUser()?.preferred_language) {
                updateLanguageDisplay(preferences.preferred_language);
            }
        } else {
            RecipeApp.showAlert(data.message || 'Failed to save preferences', 'error');
        }
    } catch (error) {
        RecipeApp.hideLoading();
        console.error('Preferences update error:', error);
        RecipeApp.showAlert('Failed to save preferences', 'error');
    }
}

function setupDeleteConfirmation() {
    const deleteBtn = document.getElementById('deleteAccount');
    const confirmInput = document.getElementById('deleteConfirmation');
    const confirmBtn = document.getElementById('confirmDelete');
    
    if (deleteBtn) {
        deleteBtn.addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
            modal.show();
        });
    }
    
    if (confirmInput) {
        confirmInput.addEventListener('input', function() {
            confirmBtn.disabled = this.value !== 'DELETE';
        });
    }
    
    if (confirmBtn) {
        confirmBtn.addEventListener('click', handleAccountDeletion);
    }
}

async function handleAccountDeletion() {
    try {
        RecipeApp.showLoading('Deleting account...', 'This may take a few moments');
        
        const response = await fetch('/auth/delete-account', {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${RecipeApp.authToken()}`,
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();
        RecipeApp.hideLoading();

        if (data.success) {
            RecipeApp.showAlert('Account deleted successfully. You will be redirected...', 'success');
            
            setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/';
            }, 3000);
        } else {
            RecipeApp.showAlert(data.message || 'Failed to delete account', 'error');
        }
    } catch (error) {
        RecipeApp.hideLoading();
        console.error('Account deletion error:', error);
        RecipeApp.showAlert('Failed to delete account', 'error');
    }
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        button.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        button.className = 'fas fa-eye';
    }
}

function resetForm() {
    document.getElementById('profileSettingsForm').reset();
    RecipeApp.showAlert('Form reset to original values', 'info');
}

// Load more activity handler
document.getElementById('loadMoreActivity').addEventListener('click', function() {
    RecipeApp.showAlert('Loading more activity...', 'info');
});

// 2FA and security handlers
document.getElementById('enable2FA').addEventListener('click', function() {
    RecipeApp.showAlert('Two-factor authentication setup coming soon!', 'info');
});

document.getElementById('manageSessions').addEventListener('click', function() {
    RecipeApp.showAlert('Session management coming soon!', 'info');
});

document.getElementById('exportData').addEventListener('click', function() {
    RecipeApp.showAlert('Data export feature coming soon!', 'info');
});
</script>
{% endblock %}
